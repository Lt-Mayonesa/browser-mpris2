<meta charset="utf-8"/>
<title>Testsing in the browser?</title>
<style>
    body {
        --background: white;
        --textColor: black;
        --keywordHighlight: #ffff0021;
        --success: green;
        --error: red;
        --typeBackground: lightgrey;
        --valueBackground: lightblue;

        font-family: sans-serif;
        background-color: var(--background);
        color: var(--textColor);
    }

    .result {
        font-family: monospace;
        line-height: 20px;
    }

    h2 span {
        float: right;
    }

    span.keyword {
        background-color: var(--keywordHighlight);
        padding: 4px;
        border-radius: 2px;
    }

    span.type, span.value {
        border-radius: 2px;
        padding: 0 2px;
        border-radius: 2px;
    }

    span.value {
        background-color: var(--valueBackground);
    }

    span.type {
        background-color: var(--typeBackground);
    }

    ol {
        overflow: hidden;
    }

    ol li.success {
        border-left: 10px solid var(--success);
        padding-left: 8px;
    }

    ol li.error {
        border-left: 10px solid var(--error);
        padding-left: 8px;
    }
</style>
<body>
<div>
    Themes:
    <button onclick="setTheme('white')">White</button>
    <button onclick="setTheme('black')">Black</button>
</div>
<h1>browser-mpris2</h1>
<div class="content">
    <ul id="list">

    </ul>
</div>

<!-- test files -->
<script src="event-emitter.js"></script>
<script src="titb-errors.js"></script>
<script src="titb-assertables.js"></script>
<script src="titb.js"></script>

<!-- source files -->
<script src="../../src/player.js"></script>
<script src="../../src/host.js"></script>
<script src="../../src/playback.js"></script>
<script src="../../src/page.js"></script>
<script src="../../src/messenger.js"></script>

<!-- suites -->
<script src="../player.spec.js"></script>
<script src="../page.spec.js"></script>
<script src="../messenger.spec.js"></script>

<script>
    String.prototype.slug = function () {
        return this.toLowerCase()
          .replace(/\s+/g, '-')           // Replace spaces with -
          .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
          .replace(/\-\-+/g, '-')         // Replace multiple - with single -
          .replace(/^-+/, '')             // Trim - from start of text
          .replace(/-+$/, '');            // Trim - from end of text
    };

    function drawSpec (title, result) {
        let list = document.getElementById(title.slug());
        let h2 = null;
        if (!list) {
            let elm = document.createElement('li');
            h2 = document.createElement('h2');
            h2.innerText = title;
            elm.append(h2);
            list = document.createElement('ol');
            list.id = title.slug();
            elm.append(list);
            document.getElementById('list').append(elm);
        } else {
            h2 = list.parentElement.firstChild;
        }
        if (result) {
            h2.insertAdjacentHTML('beforeend',`<span>Passed ${result.success} of ${result.total}</span>`);
            if (result.success === result.total)
                list.style.height = 0;
        }
    }

    function drawTest (spec, title, parameters, error) {
        let elm = document.createElement('li');

        elm.id = `${spec.slug()}_${replaceParameters(title, parameters).slug()}`;
        elm.innerHTML = title.replace(/\b(given|when|then|it)\b/gi, '<span class="keyword">$&</span>');
        document.getElementById(spec.slug()).append(elm);

        elm.className = error ? 'error' : 'success';
        let p = document.createElement('p');
        p.className = 'result';
        p.innerHTML = error ? (error.html || error) : '';
        elm.append(p);
    }

    /**
     *
     * @param {string} title
     * @param {Object} parameters
     */
    function replaceParameters (title, parameters) {
        parameters = parameters || {};
        Object.keys(parameters).forEach(each => {
            title = title.replace(new RegExp('\\$' + each, 'g'), `<b>${JSON.stringify(parameters[each])}</b>`);
        });
        return title;
    }

    new Titb()
      .on('suite:start', console.log)
      .on('suite:end', console.log)
      .on('test:start', (suite, test, params) => console.log(`  ${test}`, params))
      .on('test:step', (suite, test, key) => console.log(`      ${key}`))
      .on('test:success', () => console.log(`  OK`))
      .on('suite:start', drawSpec)
      .on('suite:end', drawSpec)
      .on('test:success', drawTest)
      .on('test:fail', drawTest)
      .testSuite();

    setTheme(localStorage.getItem('theme') || 'white');

    function setTheme (theme) {
        switch (theme) {
            case 'white':
                document.body.style.setProperty('--background', 'white');
                document.body.style.setProperty('--textColor', 'black');
                document.body.style.setProperty('--keywordHighlight', '#ffff0021');
                document.body.style.setProperty('--success', 'green');
                document.body.style.setProperty('--error', 'red');
                document.body.style.setProperty('--typeBackground', 'lightgrey');
                document.body.style.setProperty('--valueBackground', 'lightblue');
                break;
            case 'black':
                document.body.style.setProperty('--background', 'black');
                document.body.style.setProperty('--textColor', 'white');
                document.body.style.setProperty('--keywordHighlight', '#ff870033');
                document.body.style.setProperty('--success', 'green');
                document.body.style.setProperty('--error', 'red');
                document.body.style.setProperty('--typeBackground', '#464646');
                document.body.style.setProperty('--valueBackground', 'darkgoldenrod');
                break;
        }
        localStorage.setItem('theme', theme);
    }
</script>
</body>
